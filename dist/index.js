import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as o from"../../../../instruct-mode.js";import*as r from"../../../../chats.js";import*as i from"../../../../openai.js";import*as a from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";var d={d:(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},p={};d.d(p,{b:()=>en});Error;const h=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const f=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const m=(e=>{var t={};return d.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const g=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>o.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>o.formatInstructModeSystemPrompt});const v=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>r.appendFileContent});const _=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const y=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>a.metadata_keys});const b=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const E=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});(e=>{var t={};d.d(t,e)})({});(e=>{var t={};d.d(t,e)})({});async function w(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}async function S(e,t,{escapeHtml:n=!0}={}){await w("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function x(e){return(0,f.getMaxContextSize)(e)}function T(e,t){return(0,f.parseMesExamples)(e,t)}function P(e,t,n){return(0,f.baseChatReplace)(e,t,n)}function A(e){return(0,_.getPromptRole)(e)}function C(e,{wiFormat:t}={}){return(0,_.formatWorldInfo)(e,{wiFormat:t})}function D(e){return(0,_.getPromptPosition)(e)}function O(e,t={}){const n=SillyTavern.getContext(),o=t.readOnlyValues||[],r=document.querySelector(e);if(!r)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>o.includes(e);if(r.parentNode?.insertBefore(a,r),a.appendChild(r),t.initialList&&t.initialList.length>0){r.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),o=e(n);t.value=o,t.textContent=i(o),s(o)&&(t.dataset.readonly="true"),r.appendChild(t)}}if(t.initialValue){const e=Array.from(r.options).find((e=>e.value===t.initialValue));e&&(r.value=e.value)}let l=r.value;if(r.addEventListener("change",(async()=>{const e=r.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const o=i("");e.title=`Create a new ${o}`,e.setAttribute("data-i18n",`[title]Create a new ${o}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),o=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===o||""===o.trim())return;let a=o.trim();if(Array.from(r.options).some((e=>e.value===a)))return void await S("warning",`A ${i(a)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(a))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(a);"string"==typeof e&&(a=e)}const s=document.createElement("option");s.value=a,s.textContent=i(a),r.appendChild(s);const c=r.value;r.value=a,t.onSelectChange&&c!==a&&await t.onSelectChange(c,a),l=a})),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const o=i("");e.title=`Rename a ${o}`,e.setAttribute("data-i18n",`[title]Rename a ${o}`),e.addEventListener("click",(async()=>{if(-1===r.selectedIndex)return void await S("warning",`Please select a ${i("")} to rename.`);const e=r.options[r.selectedIndex];let o=e.value;if(s(o))return void await S("warning",`This ${i(o)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i(o)}`,`Please enter a new name for "${o}":`,o);if(null===a||""===a.trim()||a===o)return;let c=a.trim();if(Array.from(r.options).some((t=>t.value===c&&t!==e)))await S("warning",`A ${i(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(o,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(o,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=i(c),o===l&&(l=c),t.onSelectChange&&r.value===c&&await t.onSelectChange(o,c)}})),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const o=i("");e.title=`Delete a ${o}`,e.setAttribute("data-i18n",`[title]Delete a ${o}`),e.addEventListener("click",(async()=>{if(-1===r.selectedIndex)return void await S("warning",`Please select a ${i("")} to delete.`);const e=r.options[r.selectedIndex],o=e.value,a=r.selectedIndex;if(s(o))return void await S("warning",`This ${i(o)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(o)}`,`Are you sure you want to delete "${o}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(o))return}const c=o;let u,d=-1;r.options.length>1&&(d=a<r.options.length-1?a:a-1,u=r.options[d].value),r.removeChild(e),d>=0?(r.selectedIndex=d,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)})),a.appendChild(e)}return{select:r,container:a}}async function R(e,{targetCharacterId:t,presetName:n,instructName:o,contextName:r,syspromptName:i,maxContext:a,includeNames:s,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let w=[],{description:S,personality:O,persona:R,scenario:N,mesExamples:I,system:M,jailbreak:k}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const L="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(o):void 0,F=!!L?.enabled;let B=T(I,F);let G=[];const j=function(){if("number"==typeof a)return a;if(!a)return x();if("active"===a||!n)return x();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:x()}();if(j<=0)return{result:[],warnings:G};const $=p.ToolManager.isToolCallingSupported(),H=d?.start??0,U=d?.end?d.end+1:void 0;let Y=-1===H&&0===U?[]:p.chat.slice(H,U).filter((e=>!e.is_system||$&&Array.isArray(e.extra?.tool_invocations)));Y=await Promise.all(Y.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:o,isPrompt:r,isEdit:i,depth:a}){return(0,E.getRegexedString)(e,t,{characterOverride:n,isMarkdown:o,isPrompt:r,isEdit:i,depth:a})}(e.mes,e.is_user?E.regex_placement.USER_INPUT:E.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:Y.length-t-1});return n=await async function(e,t){return await(0,v.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const V=Y.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:X,worldInfoBefore:W,worldInfoAfter:q,worldInfoExamples:z,worldInfoDepth:K,anBefore:Q,anAfter:Z}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(V,j,!1);for(const se of z){const le=se.content;if(0===le.length)continue;const ce=T(P(le,f.name1,f.name2),F);se.position===m.wi_anchor_position.before?B.unshift(...ce):B.push(...ce)}function J(){let e=0;const t=[];for(let n=Y.length-1;n>=0;n--){const o=Y[n];if(o.extra?.token_count&&e+o.extra.token_count>j)break;e+=o.extra?.token_count||0,t.unshift({role:o.is_user?"user":"assistant",content:s?`${o.name}: ${o.mes}`:o.mes})}w.push(...t)}if("textgenerationwebui"===e){const ue=[...B];B&&(B=function(e,t,n){return(0,g.formatInstructModeExamples)(e,t,n)}(B,f.name1,f.name2));const de=p.getPresetManager("sysprompt")?.getCompletionPresetByName(i);de&&(M=p.powerUserSettings.prefer_character_prompt&&M?M:P(de.content,f.name1,f.name2),M=F?(te=p.substituteParams(M,f.name1,f.name2,de.content),ne=L,(0,g.formatInstructModeSystemPrompt)(te,ne)):M);const pe={description:S,personality:O,persona:p.powerUserSettings.persona_description_position==h.persona_description_positions.IN_PROMPT?R:"",scenario:N,system:M,char:f.name2,user:f.name1,wiBefore:W,wiAfter:q,loreBefore:W,loreAfter:q,mesExamples:B.join(""),mesExamplesRaw:ue.join("")},he=p.getPresetManager("context")?.getCompletionPresetByName(r);let fe=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,h.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(pe,{customInstructSettings:L,customStoryString:he?.story_string});w.push({role:"system",content:fe,ignoreInstruct:!0}),J()}else{let me=(ee=Y,(0,_.setOpenAIMessages)(ee)),ge=function(e){return(0,_.setOpenAIMessageExamples)(e)}(B);async function ve(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:o,worldInfoBefore:r,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,messages:m,messageExamples:g},v){return(0,_.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:o,worldInfoBefore:r,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:f.name2,charDescription:S,charPersonality:O,Scenario:N,worldInfoBefore:W,worldInfoAfter:q,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:M,jailbreakPromptOverride:k,personaDescription:R,messages:me,messageExamples:ge},!1);w.push(...e)}if(!n)return G.push("No preset name provided. Using default preset."),await ve(),{result:w,warnings:G};const _e=p.getPresetManager("openai")?.getCompletionPresetByName(n);if(!_e)return console.warn(`Preset not found: ${n}. Using current preset.`),G.push(`Preset not found: ${n}. Using current preset.`),ve(),{result:w,warnings:G};let ye=_e.prompt_order?.find((e=>e.character_id===f.this_chid));if(!ye&&_e.prompt_order&&_e.prompt_order.length>0&&(ye=_e.prompt_order[0]),!ye)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),G.push(`No prompt order found for preset: ${n}. Using current preset.`),ve(),{result:w,warnings:G};const be=N&&_e.scenario_format?p.substituteParams(_e.scenario_format):"",Ee=O&&_e.personality_format?p.substituteParams(_e.personality_format):"",we=p.substituteParams(_e.group_nudge_prompt),Se=_e.impersonation_prompt?p.substituteParams(_e.impersonation_prompt):"",xe=[];u&&xe.push({role:"system",content:C(W,{wiFormat:_e.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:C(q,{wiFormat:_e.wi_format}),identifier:"worldInfoAfter"}),l||xe.push({role:"system",content:S,identifier:"charDescription"},{role:"system",content:Ee,identifier:"charPersonality"},{role:"system",content:be,identifier:"scenario"}),xe.push({role:"system",content:Se,identifier:"impersonate"},{role:"system",content:we,identifier:"groupNudge"});const Te=p.extensionPrompts["1_memory"];Te&&Te.value&&xe.push({role:A(Te.role),content:Te.value,identifier:"summary",position:D(Te.position)});const Pe=p.extensionPrompts["2_floating_prompt"];!c&&Pe&&Pe.value&&xe.push({role:A(Pe.role),content:Pe.value,identifier:"authorsNote",position:D(Pe.position)});const Ae=p.extensionPrompts["3_vectors"];Ae&&Ae.value&&xe.push({role:"system",content:Ae.value,identifier:"vectorsMemory",position:D(Ae.position)});const Ce=p.extensionPrompts["4_vectors_data_bank"];Ce&&Ce.value&&xe.push({role:A(Ce.role),content:Ce.value,identifier:"vectorsDataBank",position:D(Ce.position)});const De=p.extensionPrompts.chromadb;De&&De.value&&xe.push({role:"system",content:De.value,identifier:"smartContext",position:D(De.position)}),!l&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===h.persona_description_positions.IN_PROMPT&&xe.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),ye.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,xe.find((e=>e.identifier===n)));var n;t&&t.content?w.push({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&J()}))}var ee,te,ne;const oe=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Oe in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Oe)){const Re=p.extensionPrompts[Oe];if(oe.includes(Oe))continue;if(!p.extensionPrompts[Oe].value)continue;if(![f.extension_prompt_types.BEFORE_PROMPT,f.extension_prompt_types.IN_PROMPT].includes(Re.position))continue;if("function"==typeof Re.filter&&!await Re.filter())continue;Re.position===f.extension_prompt_types.BEFORE_PROMPT?w=[...w.slice(0,Re.depth),{role:A(Re.role)??"system",content:Re.value},...w.slice(Re.depth)]:Re.position===f.extension_prompt_types.IN_PROMPT&&(w=[...w.slice(0,w.length-Re.depth),{role:A(Re.role)??"system",content:Re.value},...w.slice(w.length-Re.depth)])}for(const Ne of K)w=[...w.slice(0,w.length-Ne.depth),{role:A(Ne.role),content:Ne.entries.join("\n")},...w.slice(w.length-Ne.depth)];if(!l){const Ie=(re=b.selected_group,ie=Number(f.this_chid),(0,b.getGroupDepthPrompts)(re,ie));if(b.selected_group&&Array.isArray(Ie)&&Ie.length>0)Ie.filter((e=>e.text)).forEach(((e,t)=>{w=[...w.slice(0,w.length-e.depth),{role:e.role,content:e.text},...w.slice(w.length-e.depth)]}));else{const Me=P(p.characters[f.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),f.name1,f.name2)||"";if(Me){const ke=f.depth_prompt_depth_default,Le=p.characters[f.this_chid]?.data?.extensions?.depth_prompt?.role??f.depth_prompt_role_default;w=[...w.slice(0,w.length-ke),{role:A(Le),content:Me},...w.slice(w.length-ke)]}}}var re,ie;let ae=-1;if(!c){const Fe={prompt:f.chat_metadata[y.metadata_keys.prompt],interval:f.chat_metadata[y.metadata_keys.interval],position:f.chat_metadata[y.metadata_keys.position],depth:f.chat_metadata[y.metadata_keys.depth],role:f.chat_metadata[y.metadata_keys.role]};if(Fe.prompt)switch(Fe.prompt=P(Fe.prompt,f.name1,f.name2),Fe.position){case f.extension_prompt_types.IN_PROMPT:w=[...w.slice(0,1),{role:"user",content:Fe.prompt},...w.slice(1)],ae=1;break;case f.extension_prompt_types.IN_CHAT:w=[...w.slice(0,w.length-Fe.depth),{role:A(Fe.role),content:Fe.prompt},...w.slice(w.length-Fe.depth)],ae=w.length-Fe.depth-1;break;case f.extension_prompt_types.BEFORE_PROMPT:w.unshift({role:"user",content:Fe.prompt}),ae=0}}return ae>=0&&(Q.length>0&&(w=[...w.slice(0,ae),{role:"system",content:Q.join("\n")},...w.slice(ae)],ae++),Z.length>0&&(w=[...w.slice(0,ae+1),{role:"system",content:Z.join("\n")},...w.slice(ae+1)])),{result:w,warnings:G}}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function N(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?N(Object(n),!0).forEach((function(t){k(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):N(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function M(e){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M(e)}function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function L(){return L=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},L.apply(this,arguments)}function F(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function B(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var G=B(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),j=B(/Edge/i),H=B(/firefox/i),U=B(/safari/i)&&!B(/chrome/i)&&!B(/android/i),Y=B(/iP(ad|od|hone)/i),V=B(/chrome/i)&&B(/android/i),X={capture:!1,passive:!1};function W(e,t,n){e.addEventListener(t,n,!G&&X)}function q(e,t,n){e.removeEventListener(t,n,!G&&X)}function z(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function K(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function Q(e,t,n,o){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&z(e,t):z(e,t))||o&&e===n)return e;if(e===n)break}while(e=K(e))}return null}var Z,J=/\s+/g;function ee(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var o=(" "+e.className+" ").replace(J," ").replace(" "+t+" "," ");e.className=(o+(n?" "+t:"")).replace(J," ")}}function te(e,t,n){var o=e&&e.style;if(o){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in o||-1!==t.indexOf("webkit")||(t="-webkit-"+t),o[t]=n+("string"==typeof n?"":"px")}}function ne(e,t){var n="";if("string"==typeof e)n=e;else do{var o=te(e,"transform");o&&"none"!==o&&(n=o+" "+n)}while(!t&&(e=e.parentNode));var r=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return r&&new r(n)}function oe(e,t,n){if(e){var o=e.getElementsByTagName(t),r=0,i=o.length;if(n)for(;r<i;r++)n(o[r],r);return o}return[]}function re(){var e=document.scrollingElement;return e||document.documentElement}function ie(e,t,n,o,r){if(e.getBoundingClientRect||e===window){var i,a,s,l,c,u,d;if(e!==window&&e.parentNode&&e!==re()?(a=(i=e.getBoundingClientRect()).top,s=i.left,l=i.bottom,c=i.right,u=i.height,d=i.width):(a=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,d=window.innerWidth),(t||n)&&e!==window&&(r=r||e.parentNode,!G))do{if(r&&r.getBoundingClientRect&&("none"!==te(r,"transform")||n&&"static"!==te(r,"position"))){var p=r.getBoundingClientRect();a-=p.top+parseInt(te(r,"border-top-width")),s-=p.left+parseInt(te(r,"border-left-width")),l=a+i.height,c=s+i.width;break}}while(r=r.parentNode);if(o&&e!==window){var h=ne(r||e),f=h&&h.a,m=h&&h.d;h&&(l=(a/=m)+(u/=m),c=(s/=f)+(d/=f))}return{top:a,left:s,bottom:l,right:c,width:d,height:u}}}function ae(e,t,n){for(var o=de(e,!0),r=ie(e)[t];o;){var i=ie(o)[n];if(!("top"===n||"left"===n?r>=i:r<=i))return o;if(o===re())break;o=de(o,!1)}return!1}function se(e,t,n,o){for(var r=0,i=0,a=e.children;i<a.length;){if("none"!==a[i].style.display&&a[i]!==gt.ghost&&(o||a[i]!==gt.dragged)&&Q(a[i],n.draggable,e,!1)){if(r===t)return a[i];r++}i++}return null}function le(e,t){for(var n=e.lastElementChild;n&&(n===gt.ghost||"none"===te(n,"display")||t&&!z(n,t));)n=n.previousElementSibling;return n||null}function ce(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===gt.clone||t&&!z(e,t)||n++;return n}function ue(e){var t=0,n=0,o=re();if(e)do{var r=ne(e),i=r.a,a=r.d;t+=e.scrollLeft*i,n+=e.scrollTop*a}while(e!==o&&(e=e.parentNode));return[t,n]}function de(e,t){if(!e||!e.getBoundingClientRect)return re();var n=e,o=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var r=te(n);if(n.clientWidth<n.scrollWidth&&("auto"==r.overflowX||"scroll"==r.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==r.overflowY||"scroll"==r.overflowY)){if(!n.getBoundingClientRect||n===document.body)return re();if(o||t)return n;o=!0}}}while(n=n.parentNode);return re()}function pe(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function he(e,t){return function(){if(!Z){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),Z=setTimeout((function(){Z=void 0}),t)}}}function fe(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function me(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function ge(e,t,n){var o={};return Array.from(e.children).forEach((function(r){var i,a,s,l;if(Q(r,t.draggable,e,!1)&&!r.animated&&r!==n){var c=ie(r);o.left=Math.min(null!==(i=o.left)&&void 0!==i?i:1/0,c.left),o.top=Math.min(null!==(a=o.top)&&void 0!==a?a:1/0,c.top),o.right=Math.max(null!==(s=o.right)&&void 0!==s?s:-1/0,c.right),o.bottom=Math.max(null!==(l=o.bottom)&&void 0!==l?l:-1/0,c.bottom)}})),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var ve="Sortable"+(new Date).getTime();function _e(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach((function(e){if("none"!==te(e,"display")&&e!==gt.ghost){t.push({target:e,rect:ie(e)});var n=I({},t[t.length-1].rect);if(e.thisAnimationDuration){var o=ne(e,!0);o&&(n.top-=o.f,n.left-=o.e)}e.fromRect=n}}))},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var o in t)if(t.hasOwnProperty(o)&&t[o]===e[n][o])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var o=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var r=!1,i=0;t.forEach((function(e){var t=0,n=e.target,a=n.fromRect,s=ie(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,d=ne(n,!0);d&&(s.top-=d.f,s.left-=d.e),n.toRect=s,n.thisAnimationDuration&&pe(l,s)&&!pe(a,s)&&(u.top-s.top)/(u.left-s.left)==(a.top-s.top)/(a.left-s.left)&&(t=function(e,t,n,o){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*o.animation}(u,l,c,o.options)),pe(s,a)||(n.prevFromRect=a,n.prevToRect=s,t||(t=o.options.animation),o.animate(n,u,s,t)),t&&(r=!0,i=Math.max(i,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout((function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null}),t),n.thisAnimationDuration=t)})),clearTimeout(e),r?e=setTimeout((function(){"function"==typeof n&&n()}),i):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,o){if(o){te(e,"transition",""),te(e,"transform","");var r=ne(this.el),i=r&&r.a,a=r&&r.d,s=(t.left-n.left)/(i||1),l=(t.top-n.top)/(a||1);e.animatingX=!!s,e.animatingY=!!l,te(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),te(e,"transition","transform "+o+"ms"+(this.options.easing?" "+this.options.easing:"")),te(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout((function(){te(e,"transition",""),te(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1}),o)}}}}var ye=[],be={initializeByDefault:!0},Ee={mount:function(e){for(var t in be)be.hasOwnProperty(t)&&!(t in e)&&(e[t]=be[t]);ye.forEach((function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")})),ye.push(e)},pluginEvent:function(e,t,n){var o=this;this.eventCanceled=!1,n.cancel=function(){o.eventCanceled=!0};var r=e+"Global";ye.forEach((function(o){t[o.pluginName]&&(t[o.pluginName][r]&&t[o.pluginName][r](I({sortable:t},n)),t.options[o.pluginName]&&t[o.pluginName][e]&&t[o.pluginName][e](I({sortable:t},n)))}))},initializePlugins:function(e,t,n,o){for(var r in ye.forEach((function(o){var r=o.pluginName;if(e.options[r]||o.initializeByDefault){var i=new o(e,t,e.options);i.sortable=e,i.options=e.options,e[r]=i,L(n,i.defaults)}})),e.options)if(e.options.hasOwnProperty(r)){var i=this.modifyOption(e,r,e.options[r]);void 0!==i&&(e.options[r]=i)}},getEventProperties:function(e,t){var n={};return ye.forEach((function(o){"function"==typeof o.eventProperties&&L(n,o.eventProperties.call(t[o.pluginName],e))})),n},modifyOption:function(e,t,n){var o;return ye.forEach((function(r){e[r.pluginName]&&r.optionListeners&&"function"==typeof r.optionListeners[t]&&(o=r.optionListeners[t].call(e[r.pluginName],n))})),o}};function we(e){var t=e.sortable,n=e.rootEl,o=e.name,r=e.targetEl,i=e.cloneEl,a=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,d=e.newDraggableIndex,p=e.originalEvent,h=e.putSortable,f=e.extraEventProperties;if(t=t||n&&n[ve]){var m,g=t.options,v="on"+o.charAt(0).toUpperCase()+o.substr(1);!window.CustomEvent||G||j?(m=document.createEvent("Event")).initEvent(o,!0,!0):m=new CustomEvent(o,{bubbles:!0,cancelable:!0}),m.to=a||n,m.from=s||n,m.item=r||n,m.clone=i,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=d,m.originalEvent=p,m.pullMode=h?h.lastPutMode:void 0;var _=I(I({},f),Ee.getEventProperties(o,t));for(var y in _)m[y]=_[y];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var Se=["evt"],xe=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.evt,r=F(n,Se);Ee.pluginEvent.bind(gt)(e,t,I({dragEl:Pe,parentEl:Ae,ghostEl:Ce,rootEl:De,nextEl:Oe,lastDownEl:Re,cloneEl:Ne,cloneHidden:Ie,dragStarted:Xe,putSortable:Ge,activeSortable:gt.active,originalEvent:o,oldIndex:Me,oldDraggableIndex:Le,newIndex:ke,newDraggableIndex:Fe,hideGhostForTarget:pt,unhideGhostForTarget:ht,cloneNowHidden:function(){Ie=!0},cloneNowShown:function(){Ie=!1},dispatchSortableEvent:function(e){Te({sortable:t,name:e,originalEvent:o})}},r))};function Te(e){we(I({putSortable:Ge,cloneEl:Ne,targetEl:Pe,rootEl:De,oldIndex:Me,oldDraggableIndex:Le,newIndex:ke,newDraggableIndex:Fe},e))}var Pe,Ae,Ce,De,Oe,Re,Ne,Ie,Me,ke,Le,Fe,Be,Ge,je,$e,He,Ue,Ye,Ve,Xe,We,qe,ze,Ke,Qe=!1,Ze=!1,Je=[],et=!1,tt=!1,nt=[],ot=!1,rt=[],it="undefined"!=typeof document,at=Y,st=j||G?"cssFloat":"float",lt=it&&!V&&!Y&&"draggable"in document.createElement("div"),ct=function(){if(it){if(G)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),ut=function(e,t){var n=te(e),o=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),r=se(e,0,t),i=se(e,1,t),a=r&&te(r),s=i&&te(i),l=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+ie(r).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+ie(i).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(r&&a.float&&"none"!==a.float){var u="left"===a.float?"left":"right";return!i||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return r&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||l>=o&&"none"===n[st]||i&&"none"===n[st]&&l+c>o)?"vertical":"horizontal"},dt=function(e){function t(e,n){return function(o,r,i,a){var s=o.options.group.name&&r.options.group.name&&o.options.group.name===r.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(o,r,i,a),n)(o,r,i,a);var l=(n?o:r).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},o=e.group;o&&"object"==M(o)||(o={name:o}),n.name=o.name,n.checkPull=t(o.pull,!0),n.checkPut=t(o.put),n.revertClone=o.revertClone,e.group=n},pt=function(){!ct&&Ce&&te(Ce,"display","none")},ht=function(){!ct&&Ce&&te(Ce,"display","")};it&&!V&&document.addEventListener("click",(function(e){if(Ze)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),Ze=!1,!1}),!0);var ft=function(e){if(Pe){var t=function(e,t){var n;return Je.some((function(o){var r=o[ve].options.emptyInsertThreshold;if(r&&!le(o)){var i=ie(o),a=e>=i.left-r&&e<=i.right+r,s=t>=i.top-r&&t<=i.bottom+r;return a&&s?n=o:void 0}})),n}((e=e.touches?e.touches[0]:e).clientX,e.clientY);if(t){var n={};for(var o in e)e.hasOwnProperty(o)&&(n[o]=e[o]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[ve]._onDragOver(n)}}},mt=function(e){Pe&&Pe.parentNode[ve]._isOutsideThisEl(e.target)};function gt(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=L({},t),e[ve]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return ut(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==gt.supportPointer&&"PointerEvent"in window&&(!U||Y),emptyInsertThreshold:5};for(var o in Ee.initializePlugins(this,e,n),n)!(o in t)&&(t[o]=n[o]);for(var r in dt(t),this)"_"===r.charAt(0)&&"function"==typeof this[r]&&(this[r]=this[r].bind(this));this.nativeDraggable=!t.forceFallback&&lt,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?W(e,"pointerdown",this._onTapStart):(W(e,"mousedown",this._onTapStart),W(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(W(e,"dragover",this),W(e,"dragenter",this)),Je.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),L(this,_e())}function vt(e,t,n,o,r,i,a,s){var l,c,u=e[ve],d=u.options.onMove;return!window.CustomEvent||G||j?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=o,l.related=r||t,l.relatedRect=i||ie(t),l.willInsertAfter=s,l.originalEvent=a,e.dispatchEvent(l),d&&(c=d.call(u,l,a)),c}function _t(e){e.draggable=!1}function yt(){ot=!1}function bt(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,o=0;n--;)o+=t.charCodeAt(n);return o.toString(36)}function Et(e){return setTimeout(e,0)}function wt(e){return clearTimeout(e)}gt.prototype={constructor:gt,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(We=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Pe):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,o=this.options,r=o.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(a||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=o.filter;if(function(e){rt.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var o=t[n];o.checked&&rt.push(o)}}(n),!Pe&&!(/mousedown|pointerdown/.test(i)&&0!==e.button||o.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!U||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=Q(s,o.draggable,n,!1))&&s.animated||Re===s)){if(Me=ce(s),Le=ce(s,o.draggable),"function"==typeof c){if(c.call(this,e,s,this))return Te({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),xe("filter",t,{evt:e}),void(r&&e.preventDefault())}else if(c&&(c=c.split(",").some((function(o){if(o=Q(l,o.trim(),n,!1))return Te({sortable:t,rootEl:o,name:"filter",targetEl:s,fromEl:n,toEl:n}),xe("filter",t,{evt:e}),!0}))))return void(r&&e.preventDefault());o.handle&&!Q(l,o.handle,n,!1)||this._prepareDragStart(e,a,s)}}},_prepareDragStart:function(e,t,n){var o,r=this,i=r.el,a=r.options,s=i.ownerDocument;if(n&&!Pe&&n.parentNode===i){var l=ie(n);if(De=i,Ae=(Pe=n).parentNode,Oe=Pe.nextSibling,Re=n,Be=a.group,gt.dragged=Pe,je={target:Pe,clientX:(t||e).clientX,clientY:(t||e).clientY},Ye=je.clientX-l.left,Ve=je.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Pe.style["will-change"]="all",o=function(){xe("delayEnded",r,{evt:e}),gt.eventCanceled?r._onDrop():(r._disableDelayedDragEvents(),!H&&r.nativeDraggable&&(Pe.draggable=!0),r._triggerDragStart(e,t),Te({sortable:r,name:"choose",originalEvent:e}),ee(Pe,a.chosenClass,!0))},a.ignore.split(",").forEach((function(e){oe(Pe,e.trim(),_t)})),W(s,"dragover",ft),W(s,"mousemove",ft),W(s,"touchmove",ft),a.supportPointer?(W(s,"pointerup",r._onDrop),!this.nativeDraggable&&W(s,"pointercancel",r._onDrop)):(W(s,"mouseup",r._onDrop),W(s,"touchend",r._onDrop),W(s,"touchcancel",r._onDrop)),H&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Pe.draggable=!0),xe("delayStart",this,{evt:e}),!a.delay||a.delayOnTouchOnly&&!t||this.nativeDraggable&&(j||G))o();else{if(gt.eventCanceled)return void this._onDrop();a.supportPointer?(W(s,"pointerup",r._disableDelayedDrag),W(s,"pointercancel",r._disableDelayedDrag)):(W(s,"mouseup",r._disableDelayedDrag),W(s,"touchend",r._disableDelayedDrag),W(s,"touchcancel",r._disableDelayedDrag)),W(s,"mousemove",r._delayedDragTouchMoveHandler),W(s,"touchmove",r._delayedDragTouchMoveHandler),a.supportPointer&&W(s,"pointermove",r._delayedDragTouchMoveHandler),r._dragStartTimer=setTimeout(o,a.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Pe&&_t(Pe),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;q(e,"mouseup",this._disableDelayedDrag),q(e,"touchend",this._disableDelayedDrag),q(e,"touchcancel",this._disableDelayedDrag),q(e,"pointerup",this._disableDelayedDrag),q(e,"pointercancel",this._disableDelayedDrag),q(e,"mousemove",this._delayedDragTouchMoveHandler),q(e,"touchmove",this._delayedDragTouchMoveHandler),q(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?W(document,"pointermove",this._onTouchMove):W(document,t?"touchmove":"mousemove",this._onTouchMove):(W(Pe,"dragend",this),W(De,"dragstart",this._onDragStart));try{document.selection?Et((function(){document.selection.empty()})):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if(Qe=!1,De&&Pe){xe("dragStarted",this,{evt:t}),this.nativeDraggable&&W(document,"dragover",mt);var n=this.options;!e&&ee(Pe,n.dragClass,!1),ee(Pe,n.ghostClass,!0),gt.active=this,e&&this._appendGhost(),Te({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if($e){this._lastX=$e.clientX,this._lastY=$e.clientY,pt();for(var e=document.elementFromPoint($e.clientX,$e.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint($e.clientX,$e.clientY))!==t;)t=e;if(Pe.parentNode[ve]._isOutsideThisEl(e),t)do{if(t[ve]){if(t[ve]._onDragOver({clientX:$e.clientX,clientY:$e.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=K(t));ht()}},_onTouchMove:function(e){if(je){var t=this.options,n=t.fallbackTolerance,o=t.fallbackOffset,r=e.touches?e.touches[0]:e,i=Ce&&ne(Ce,!0),a=Ce&&i&&i.a,s=Ce&&i&&i.d,l=at&&Ke&&ue(Ke),c=(r.clientX-je.clientX+o.x)/(a||1)+(l?l[0]-nt[0]:0)/(a||1),u=(r.clientY-je.clientY+o.y)/(s||1)+(l?l[1]-nt[1]:0)/(s||1);if(!gt.active&&!Qe){if(n&&Math.max(Math.abs(r.clientX-this._lastX),Math.abs(r.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(Ce){i?(i.e+=c-(He||0),i.f+=u-(Ue||0)):i={a:1,b:0,c:0,d:1,e:c,f:u};var d="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");te(Ce,"webkitTransform",d),te(Ce,"mozTransform",d),te(Ce,"msTransform",d),te(Ce,"transform",d),He=c,Ue=u,$e=r}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!Ce){var e=this.options.fallbackOnBody?document.body:De,t=ie(Pe,!0,at,!0,e),n=this.options;if(at){for(Ke=e;"static"===te(Ke,"position")&&"none"===te(Ke,"transform")&&Ke!==document;)Ke=Ke.parentNode;Ke!==document.body&&Ke!==document.documentElement?(Ke===document&&(Ke=re()),t.top+=Ke.scrollTop,t.left+=Ke.scrollLeft):Ke=re(),nt=ue(Ke)}ee(Ce=Pe.cloneNode(!0),n.ghostClass,!1),ee(Ce,n.fallbackClass,!0),ee(Ce,n.dragClass,!0),te(Ce,"transition",""),te(Ce,"transform",""),te(Ce,"box-sizing","border-box"),te(Ce,"margin",0),te(Ce,"top",t.top),te(Ce,"left",t.left),te(Ce,"width",t.width),te(Ce,"height",t.height),te(Ce,"opacity","0.8"),te(Ce,"position",at?"absolute":"fixed"),te(Ce,"zIndex","100000"),te(Ce,"pointerEvents","none"),gt.ghost=Ce,e.appendChild(Ce),te(Ce,"transform-origin",Ye/parseInt(Ce.style.width)*100+"% "+Ve/parseInt(Ce.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,o=e.dataTransfer,r=n.options;xe("dragStart",this,{evt:e}),gt.eventCanceled?this._onDrop():(xe("setupClone",this),gt.eventCanceled||((Ne=me(Pe)).removeAttribute("id"),Ne.draggable=!1,Ne.style["will-change"]="",this._hideClone(),ee(Ne,this.options.chosenClass,!1),gt.clone=Ne),n.cloneId=Et((function(){xe("clone",n),gt.eventCanceled||(n.options.removeCloneOnHide||De.insertBefore(Ne,Pe),n._hideClone(),Te({sortable:n,name:"clone"}))})),!t&&ee(Pe,r.dragClass,!0),t?(Ze=!0,n._loopId=setInterval(n._emulateDragOver,50)):(q(document,"mouseup",n._onDrop),q(document,"touchend",n._onDrop),q(document,"touchcancel",n._onDrop),o&&(o.effectAllowed="move",r.setData&&r.setData.call(n,o,Pe)),W(document,"drop",n),te(Pe,"transform","translateZ(0)")),Qe=!0,n._dragStartId=Et(n._dragStarted.bind(n,t,e)),W(document,"selectstart",n),Xe=!0,window.getSelection().removeAllRanges(),U&&te(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,o,r,i=this.el,a=e.target,s=this.options,l=s.group,c=gt.active,u=Be===l,d=s.sort,p=Ge||c,h=this,f=!1;if(!ot){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),a=Q(a,s.draggable,i,!0),D("dragOver"),gt.eventCanceled)return f;if(Pe.contains(e.target)||a.animated&&a.animatingX&&a.animatingY||h._ignoreWhileAnimating===a)return R(!1);if(Ze=!1,c&&!s.disabled&&(u?d||(o=Ae!==De):Ge===this||(this.lastPutMode=Be.checkPull(this,c,Pe,e))&&l.checkPut(this,c,Pe,e))){if(r="vertical"===this._getDirection(e,a),t=ie(Pe),D("dragOverValid"),gt.eventCanceled)return f;if(o)return Ae=De,O(),this._hideClone(),D("revert"),gt.eventCanceled||(Oe?De.insertBefore(Pe,Oe):De.appendChild(Pe)),R(!0);var m=le(i,s.draggable);if(!m||function(e,t,n){var o=ie(le(n.el,n.options.draggable)),r=ge(n.el,n.options,Ce),i=10;return t?e.clientX>r.right+i||e.clientY>o.bottom&&e.clientX>o.left:e.clientY>r.bottom+i||e.clientX>o.right&&e.clientY>o.top}(e,r,this)&&!m.animated){if(m===Pe)return R(!1);if(m&&i===e.target&&(a=m),a&&(n=ie(a)),!1!==vt(De,i,Pe,t,a,n,e,!!a))return O(),m&&m.nextSibling?i.insertBefore(Pe,m.nextSibling):i.appendChild(Pe),Ae=i,N(),R(!0)}else if(m&&function(e,t,n){var o=ie(se(n.el,0,n.options,!0)),r=ge(n.el,n.options,Ce),i=10;return t?e.clientX<r.left-i||e.clientY<o.top&&e.clientX<o.right:e.clientY<r.top-i||e.clientY<o.bottom&&e.clientX<o.left}(e,r,this)){var g=se(i,0,s,!0);if(g===Pe)return R(!1);if(n=ie(a=g),!1!==vt(De,i,Pe,t,a,n,e,!1))return O(),i.insertBefore(Pe,g),Ae=i,N(),R(!0)}else if(a.parentNode===i){n=ie(a);var v,_,y,b=Pe.parentNode!==i,E=!function(e,t,n){var o=n?e.left:e.top,r=n?e.right:e.bottom,i=n?e.width:e.height,a=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return o===a||r===s||o+i/2===a+l/2}(Pe.animated&&Pe.toRect||t,a.animated&&a.toRect||n,r),w=r?"top":"left",S=ae(a,"top","top")||ae(Pe,"top","top"),x=S?S.scrollTop:void 0;if(We!==a&&(_=n[w],et=!1,tt=!E&&s.invertSwap||b),v=function(e,t,n,o,r,i,a,s){var l=o?e.clientY:e.clientX,c=o?n.height:n.width,u=o?n.top:n.left,d=o?n.bottom:n.right,p=!1;if(!a)if(s&&ze<c*r){if(!et&&(1===qe?l>u+c*i/2:l<d-c*i/2)&&(et=!0),et)p=!0;else if(1===qe?l<u+ze:l>d-ze)return-qe}else if(l>u+c*(1-r)/2&&l<d-c*(1-r)/2)return function(e){return ce(Pe)<ce(e)?1:-1}(t);if((p=p||a)&&(l<u+c*i/2||l>d-c*i/2))return l>u+c/2?1:-1;return 0}(e,a,n,r,E?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,tt,We===a),0!==v){var T=ce(Pe);do{T-=v,y=Ae.children[T]}while(y&&("none"===te(y,"display")||y===Ce))}if(0===v||y===a)return R(!1);We=a,qe=v;var P=a.nextElementSibling,A=!1,C=vt(De,i,Pe,t,a,n,e,A=1===v);if(!1!==C)return 1!==C&&-1!==C||(A=1===C),ot=!0,setTimeout(yt,30),O(),A&&!P?i.appendChild(Pe):a.parentNode.insertBefore(Pe,A?P:a),S&&fe(S,0,x-S.scrollTop),Ae=Pe.parentNode,void 0===_||tt||(ze=Math.abs(_-ie(a)[w])),N(),R(!0)}if(i.contains(Pe))return R(!1)}return!1}function D(s,l){xe(s,h,I({evt:e,isOwner:u,axis:r?"vertical":"horizontal",revert:o,dragRect:t,targetRect:n,canSort:d,fromSortable:p,target:a,completed:R,onMove:function(n,o){return vt(De,i,Pe,t,n,ie(n),e,o)},changed:N},l))}function O(){D("dragOverAnimationCapture"),h.captureAnimationState(),h!==p&&p.captureAnimationState()}function R(t){return D("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(h),h!==p&&(ee(Pe,Ge?Ge.options.ghostClass:c.options.ghostClass,!1),ee(Pe,s.ghostClass,!0)),Ge!==h&&h!==gt.active?Ge=h:h===gt.active&&Ge&&(Ge=null),p===h&&(h._ignoreWhileAnimating=a),h.animateAll((function(){D("dragOverAnimationComplete"),h._ignoreWhileAnimating=null})),h!==p&&(p.animateAll(),p._ignoreWhileAnimating=null)),(a===Pe&&!Pe.animated||a===i&&!a.animated)&&(We=null),s.dragoverBubble||e.rootEl||a===document||(Pe.parentNode[ve]._isOutsideThisEl(e.target),!t&&ft(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),f=!0}function N(){ke=ce(Pe),Fe=ce(Pe,s.draggable),Te({sortable:h,name:"change",toEl:i,newIndex:ke,newDraggableIndex:Fe,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){q(document,"mousemove",this._onTouchMove),q(document,"touchmove",this._onTouchMove),q(document,"pointermove",this._onTouchMove),q(document,"dragover",ft),q(document,"mousemove",ft),q(document,"touchmove",ft)},_offUpEvents:function(){var e=this.el.ownerDocument;q(e,"mouseup",this._onDrop),q(e,"touchend",this._onDrop),q(e,"pointerup",this._onDrop),q(e,"pointercancel",this._onDrop),q(e,"touchcancel",this._onDrop),q(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;ke=ce(Pe),Fe=ce(Pe,n.draggable),xe("drop",this,{evt:e}),Ae=Pe&&Pe.parentNode,ke=ce(Pe),Fe=ce(Pe,n.draggable),gt.eventCanceled||(Qe=!1,tt=!1,et=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),wt(this.cloneId),wt(this._dragStartId),this.nativeDraggable&&(q(document,"drop",this),q(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),U&&te(document.body,"user-select",""),te(Pe,"transform",""),e&&(Xe&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),Ce&&Ce.parentNode&&Ce.parentNode.removeChild(Ce),(De===Ae||Ge&&"clone"!==Ge.lastPutMode)&&Ne&&Ne.parentNode&&Ne.parentNode.removeChild(Ne),Pe&&(this.nativeDraggable&&q(Pe,"dragend",this),_t(Pe),Pe.style["will-change"]="",Xe&&!Qe&&ee(Pe,Ge?Ge.options.ghostClass:this.options.ghostClass,!1),ee(Pe,this.options.chosenClass,!1),Te({sortable:this,name:"unchoose",toEl:Ae,newIndex:null,newDraggableIndex:null,originalEvent:e}),De!==Ae?(ke>=0&&(Te({rootEl:Ae,name:"add",toEl:Ae,fromEl:De,originalEvent:e}),Te({sortable:this,name:"remove",toEl:Ae,originalEvent:e}),Te({rootEl:Ae,name:"sort",toEl:Ae,fromEl:De,originalEvent:e}),Te({sortable:this,name:"sort",toEl:Ae,originalEvent:e})),Ge&&Ge.save()):ke!==Me&&ke>=0&&(Te({sortable:this,name:"update",toEl:Ae,originalEvent:e}),Te({sortable:this,name:"sort",toEl:Ae,originalEvent:e})),gt.active&&(null!=ke&&-1!==ke||(ke=Me,Fe=Le),Te({sortable:this,name:"end",toEl:Ae,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){xe("nulling",this),De=Pe=Ae=Ce=Oe=Ne=Re=Ie=je=$e=Xe=ke=Fe=Me=Le=We=qe=Ge=Be=gt.dragged=gt.ghost=gt.clone=gt.active=null,rt.forEach((function(e){e.checked=!0})),rt.length=He=Ue=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Pe&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,o=0,r=n.length,i=this.options;o<r;o++)Q(e=n[o],i.draggable,this.el,!1)&&t.push(e.getAttribute(i.dataIdAttr)||bt(e));return t},sort:function(e,t){var n={},o=this.el;this.toArray().forEach((function(e,t){var r=o.children[t];Q(r,this.options.draggable,o,!1)&&(n[e]=r)}),this),t&&this.captureAnimationState(),e.forEach((function(e){n[e]&&(o.removeChild(n[e]),o.appendChild(n[e]))})),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return Q(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var o=Ee.modifyOption(this,e,t);n[e]=void 0!==o?o:t,"group"===e&&dt(n)},destroy:function(){xe("destroy",this);var e=this.el;e[ve]=null,q(e,"mousedown",this._onTapStart),q(e,"touchstart",this._onTapStart),q(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(q(e,"dragover",this),q(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),(function(e){e.removeAttribute("draggable")})),this._onDrop(),this._disableDelayedDragEvents(),Je.splice(Je.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!Ie){if(xe("hideClone",this),gt.eventCanceled)return;te(Ne,"display","none"),this.options.removeCloneOnHide&&Ne.parentNode&&Ne.parentNode.removeChild(Ne),Ie=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(Ie){if(xe("showClone",this),gt.eventCanceled)return;Pe.parentNode!=De||this.options.group.revertClone?Oe?De.insertBefore(Ne,Oe):De.appendChild(Ne):De.insertBefore(Ne,Pe),this.options.group.revertClone&&this.animate(Pe,Ne),te(Ne,"display",""),Ie=!1}}else this._hideClone()}},it&&W(document,"touchmove",(function(e){(gt.active||Qe)&&e.cancelable&&e.preventDefault()})),gt.utils={on:W,off:q,css:te,find:oe,is:function(e,t){return!!Q(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:he,closest:Q,toggleClass:ee,clone:me,index:ce,nextTick:Et,cancelNextTick:wt,detectDirection:ut,getChild:se,expando:ve},gt.get=function(e){return e[ve]},gt.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach((function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(gt.utils=I(I({},gt.utils),e.utils)),Ee.mount(e)}))},gt.create=function(e,t){return new gt(e,t)},gt.version="1.15.6";var St,xt,Tt,Pt,At,Ct,Dt=[],Ot=!1;function Rt(){Dt.forEach((function(e){clearInterval(e.pid)})),Dt=[]}function Nt(){clearInterval(Ct)}var It=he((function(e,t,n,o){if(t.scroll){var r,i=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=re(),u=!1;xt!==n&&(xt=n,Rt(),St=t.scroll,r=t.scrollFn,!0===St&&(St=de(n,!0)));var d=0,p=St;do{var h=p,f=ie(h),m=f.top,g=f.bottom,v=f.left,_=f.right,y=f.width,b=f.height,E=void 0,w=void 0,S=h.scrollWidth,x=h.scrollHeight,T=te(h),P=h.scrollLeft,A=h.scrollTop;h===c?(E=y<S&&("auto"===T.overflowX||"scroll"===T.overflowX||"visible"===T.overflowX),w=b<x&&("auto"===T.overflowY||"scroll"===T.overflowY||"visible"===T.overflowY)):(E=y<S&&("auto"===T.overflowX||"scroll"===T.overflowX),w=b<x&&("auto"===T.overflowY||"scroll"===T.overflowY));var C=E&&(Math.abs(_-i)<=s&&P+y<S)-(Math.abs(v-i)<=s&&!!P),D=w&&(Math.abs(g-a)<=s&&A+b<x)-(Math.abs(m-a)<=s&&!!A);if(!Dt[d])for(var O=0;O<=d;O++)Dt[O]||(Dt[O]={});Dt[d].vx==C&&Dt[d].vy==D&&Dt[d].el===h||(Dt[d].el=h,Dt[d].vx=C,Dt[d].vy=D,clearInterval(Dt[d].pid),0==C&&0==D||(u=!0,Dt[d].pid=setInterval(function(){o&&0===this.layer&&gt.active._onTouchMove(At);var t=Dt[this.layer].vy?Dt[this.layer].vy*l:0,n=Dt[this.layer].vx?Dt[this.layer].vx*l:0;"function"==typeof r&&"continue"!==r.call(gt.dragged.parentNode[ve],n,t,e,At,Dt[this.layer].el)||fe(Dt[this.layer].el,n,t)}.bind({layer:d}),24))),d++}while(t.bubbleScroll&&p!==c&&(p=de(p,!1)));Ot=u}}),30),Mt=function(e){var t=e.originalEvent,n=e.putSortable,o=e.dragEl,r=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||r;a();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(i("spill"),this.onSpill({dragEl:o,putSortable:n}))}};function kt(){}function Lt(){}kt.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var o=se(this.sortable.el,this.startIndex,this.options);o?this.sortable.el.insertBefore(t,o):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:Mt},L(kt,{pluginName:"revertOnSpill"}),Lt.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:Mt},L(Lt,{pluginName:"removeOnSpill"});gt.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?W(document,"dragover",this._handleAutoScroll):this.options.supportPointer?W(document,"pointermove",this._handleFallbackAutoScroll):t.touches?W(document,"touchmove",this._handleFallbackAutoScroll):W(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?q(document,"dragover",this._handleAutoScroll):(q(document,"pointermove",this._handleFallbackAutoScroll),q(document,"touchmove",this._handleFallbackAutoScroll),q(document,"mousemove",this._handleFallbackAutoScroll)),Nt(),Rt(),clearTimeout(Z),Z=void 0},nulling:function(){At=xt=St=Ot=Ct=Tt=Pt=null,Dt.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,o=(e.touches?e.touches[0]:e).clientX,r=(e.touches?e.touches[0]:e).clientY,i=document.elementFromPoint(o,r);if(At=e,t||this.options.forceAutoScrollFallback||j||G||U){It(e,this.options,i,t);var a=de(i,!0);!Ot||Ct&&o===Tt&&r===Pt||(Ct&&Nt(),Ct=setInterval((function(){var i=de(document.elementFromPoint(o,r),!0);i!==a&&(a=i,Rt()),It(e,n.options,i,t)}),10),Tt=o,Pt=r)}else{if(!this.options.bubbleScroll||de(i,!0)===re())return void Rt();It(e,this.options,de(i,!1),!1)}}},L(e,{pluginName:"scroll",initializeByDefault:!0})}),gt.mount(Lt,kt);var Ft;function Bt(e){return Bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Bt(e)}function Gt(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=Bt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=Bt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Bt(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function jt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */jt=function(){return t};var e,t={},n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,o){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new O(o||[]);return r(a,"_invoke",{value:P(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function v(){}function _(){}function y(){}var b={};c(b,a,(function(){return this}));var E=Object.getPrototypeOf,w=E&&E(E(R([])));w&&w!==n&&o.call(w,a)&&(b=w);var S=y.prototype=v.prototype=Object.create(b);function x(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function n(r,i,a,s){var l=d(e[r],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==Bt(u)&&o.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;r(this,"_invoke",{value:function(e,o){function r(){return new t((function(t,r){n(e,o,t,r)}))}return i=i?i.then(r,r):r()}})}function P(t,n,o){var r=p;return function(i,a){if(r===f)throw Error("Generator is already running");if(r===m){if("throw"===i)throw a;return{value:e,done:!0}}for(o.method=i,o.arg=a;;){var s=o.delegate;if(s){var l=A(s,o);if(l){if(l===g)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===p)throw r=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=f;var c=d(t,n,o);if("normal"===c.type){if(r=o.done?m:h,c.arg===g)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(r=m,o.method="throw",o.arg=c.arg)}}}function A(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,A(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),g;var i=d(r,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function D(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function R(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function n(){for(;++r<t.length;)if(o.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(Bt(t)+" is not iterable")}return _.prototype=y,r(S,"constructor",{value:y,configurable:!0}),r(y,"constructor",{value:_,configurable:!0}),_.displayName=c(y,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===_||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,c(e,l,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},x(T.prototype),c(T.prototype,s,(function(){return this})),t.AsyncIterator=T,t.async=function(e,n,o,r,i){void 0===i&&(i=Promise);var a=new T(u(e,n,o,r),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},x(S),c(S,l,"Generator"),c(S,a,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=R,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(D),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(o,r){return s.type="throw",s.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=o.call(a,"catchLoc"),c=o.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),D(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var r=o.arg;D(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:R(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),g}},t}function $t(e){return function(e){if(Array.isArray(e))return Ht(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return Ht(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ht(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ht(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function Ut(e,t,n,o,r,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(o,r)}function Yt(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var i=e.apply(t,n);function a(e){Ut(i,o,r,a,s,"next",e)}function s(e){Ut(i,o,r,a,s,"throw",e)}a(void 0)}))}}!function(e){e.APP_READY="app_ready",e.EXTRAS_CONNECTED="extras_connected",e.MESSAGE_SWIPED="message_swiped",e.MESSAGE_SENT="message_sent",e.MESSAGE_RECEIVED="message_received",e.MESSAGE_EDITED="message_edited",e.MESSAGE_DELETED="message_deleted",e.MESSAGE_UPDATED="message_updated",e.MESSAGE_FILE_EMBEDDED="message_file_embedded",e.MORE_MESSAGES_LOADED="more_messages_loaded",e.IMPERSONATE_READY="impersonate_ready",e.CHAT_CHANGED="chat_id_changed",e.GENERATION_AFTER_COMMANDS="GENERATION_AFTER_COMMANDS",e.GENERATION_STARTED="generation_started",e.GENERATION_STOPPED="generation_stopped",e.GENERATION_ENDED="generation_ended",e.EXTENSIONS_FIRST_LOAD="extensions_first_load",e.EXTENSION_SETTINGS_LOADED="extension_settings_loaded",e.SETTINGS_LOADED="settings_loaded",e.SETTINGS_UPDATED="settings_updated",e.GROUP_UPDATED="group_updated",e.MOVABLE_PANELS_RESET="movable_panels_reset",e.SETTINGS_LOADED_BEFORE="settings_loaded_before",e.SETTINGS_LOADED_AFTER="settings_loaded_after",e.CHATCOMPLETION_SOURCE_CHANGED="chatcompletion_source_changed",e.CHATCOMPLETION_MODEL_CHANGED="chatcompletion_model_changed",e.OAI_PRESET_CHANGED_BEFORE="oai_preset_changed_before",e.OAI_PRESET_CHANGED_AFTER="oai_preset_changed_after",e.OAI_PRESET_EXPORT_READY="oai_preset_export_ready",e.OAI_PRESET_IMPORT_READY="oai_preset_import_ready",e.WORLDINFO_SETTINGS_UPDATED="worldinfo_settings_updated",e.WORLDINFO_UPDATED="worldinfo_updated",e.CHARACTER_EDITED="character_edited",e.CHARACTER_PAGE_LOADED="character_page_loaded",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE="character_group_overlay_state_change_before",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER="character_group_overlay_state_change_after",e.USER_MESSAGE_RENDERED="user_message_rendered",e.CHARACTER_MESSAGE_RENDERED="character_message_rendered",e.FORCE_SET_BACKGROUND="force_set_background",e.CHAT_DELETED="chat_deleted",e.CHAT_CREATED="chat_created",e.GROUP_CHAT_DELETED="group_chat_deleted",e.GROUP_CHAT_CREATED="group_chat_created",e.GENERATE_BEFORE_COMBINE_PROMPTS="generate_before_combine_prompts",e.GENERATE_AFTER_COMBINE_PROMPTS="generate_after_combine_prompts",e.GENERATE_AFTER_DATA="generate_after_data",e.GROUP_MEMBER_DRAFTED="group_member_drafted",e.GROUP_WRAPPER_STARTED="group_wrapper_started",e.GROUP_WRAPPER_FINISHED="group_wrapper_finished",e.WORLD_INFO_ACTIVATED="world_info_activated",e.TEXT_COMPLETION_SETTINGS_READY="text_completion_settings_ready",e.CHAT_COMPLETION_SETTINGS_READY="chat_completion_settings_ready",e.CHAT_COMPLETION_PROMPT_READY="chat_completion_prompt_ready",e.CHARACTER_FIRST_MESSAGE_SELECTED="character_first_message_selected",e.CHARACTER_DELETED="characterDeleted",e.CHARACTER_DUPLICATED="character_duplicated",e.CHARACTER_RENAMED="character_renamed",e.SMOOTH_STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_REASONING_DONE="stream_reasoning_done",e.FILE_ATTACHMENT_DELETED="file_attachment_deleted",e.WORLDINFO_FORCE_ACTIVATE="worldinfo_force_activate",e.OPEN_CHARACTER_LIBRARY="open_character_library",e.ONLINE_STATUS_CHANGED="online_status_changed",e.IMAGE_SWIPED="image_swiped",e.CONNECTION_PROFILE_LOADED="connection_profile_loaded",e.TOOL_CALLS_PERFORMED="tool_calls_performed",e.TOOL_CALLS_RENDERED="tool_calls_rendered"}(Ft||(Ft={}));var Vt=SillyTavern.getContext(),Xt="roadway",Wt={TARGET:"roadway_target_chat",RAW_CONTENT:"roadway_raw_content",OPTIONS:"roadway_options"},qt="\nYour task this time is to write your response as if you were {{user}}, impersonating their style. Use {{user}}'s dialogue and actions so far as a guideline for how they would likely act. Don't ever write as {{char}}. Only talk and act as {{user}}. This is user description: \n\n{{persona}}\n\nWrite one single paragraph. This is what {{user}}'s focus:\n\n{{roadwaySelected}}\n".trim(),zt='\n**Modified Prompt:**\n[You are an AI brainstorming partner, helping to create immersive and surprising roleplaying experiences, building upon the established context from our previous conversation. Your task is to generate an engaging list of potential dialogue or action responses for the {{user}}, specifically tailored to their {{user}} character to the world, and the current situation as established in our previous dialogue.\nOutput **ONLY** a numbered list of 10 possible action or dialogue replies. Each dialogue or action option should be a clear, concise, and creative sentence written in plain text that directly addresses the current situation in the text.\n\nHere\'s the recent chat history :\n\n{{roadwayNoAssMessages}}\n\nTry to act like the {{user}} themselves, and think about what they would do in this situation. Consider their personality, background, and motivations. Avoid generic or overly safe options. Instead, focus on actions that are bold, unexpected, or that introduce new elements to the story. This is {{user}}\'s description:\n{{persona}}\n\nPrioritize varied action or dialogue that spans multiple domains, **including NSFW/Sensual interactions**:\n{Observation/Investigation; Persuasion; Knowledge/Lore; Deception/Manipulation; Performance/Entertainment; Technical; Emotional; Understated; NSFW/Sensual; Provocative Challenge}.\n- NSFW/Sensual options should explore intimate, erotic, or physically charged interactions that align with the characters’ chemistry and escalating tension.\n- Avoid obvious or repetitive dialogue that has already been explored or contradicts the character’s voice (confident/dominant/teasing).\n- Push boundaries: Use the established scenario to craft bold, immersive dialogue or action replies that challenge the player’s expectations.\n- Do NOT include greetings, farewells, or polite phrases when generating dialogue reply. Focus on advancing tension, power dynamics, or narrative stakes.\nGenerate exactly 10 choices. The actions must be written in plain text.]\n---\n**Example Output Structure (NSFW integrated):**\n1. "Your pulse just jumped—tell me where else I should trace that heartbeat."\n2. *Let my bulge pokes her sweet spot through the clothes*\n3. "Bite back? Prove it. Unless you’re all bark and no *bite*."\n4. *Show off my boner poking through my clothes*\n5. "Program’s glitching. Your grip’s softer than your threats."\n6. *Follow her to the bedroom and undress*\n7. *[Pulling their hips flush]* "Artillery’s loaded. Care to fire the first shot?"\n8. *Hug her from behind and speak lewdly to her ear*\n9. "Teeth are cute. But I’m more interested in your… *trigger discipline*."\n10. *Pull out and cum outside, shooting semen on her back*\n'.trim(),Kt={version:"0.4.1",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:500,promptPreset:"default",autoTrigger:!1,autoOpen:!0,impersonateApi:"main",showUseActionIcon:!0,autoSubmitUseAction:!1,useNoAss:!0,noAssRole:"user",formattedRoleplayMessagePosition:"to_var({{roadwayNoAssMessages}})",promptPresets:{default:{content:zt,extractionStrategy:"bullet",impersonate:qt}}},Qt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,o=this.defaultSettings.formatVersion,r=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:o??""},oldSettings:null,newSettings:this.defaultSettings};if(!r)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(r),version:{changed:!1,old:r.version,new:r.version},formatVersion:{changed:!1,old:r.formatVersion,new:r.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const o of Object.keys(t))void 0===e[o]?(e[o]=t[o],n=!0):"object"==typeof t[o]&&null!==t[o]&&(e[o]=e[o]||{},s(e[o],t[o])&&(n=!0));return n}n&&r.version!==n&&(a.version.changed=!0,a.version.new=n,r.version=n),o&&"*"!==o&&r.formatVersion!==o&&(a.formatVersion.changed=!0,a.formatVersion.new=o,r.formatVersion=o),(s(r,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!r.version&&(r.version=n,a.version.changed=!0,a.version.new=n),o&&!r.formatVersion&&(r.formatVersion=o,a.formatVersion.changed=!0,a.formatVersion.new=o);let l=structuredClone(r),c=r.formatVersion;try{let u;do{u=!1;let d=t.find((e=>e.from===c));if(d&&d.to>c)l=await d.action(l),c=d.to,l.formatVersion=d.to,u=!0;else for(const p of t)if("*"===p.from&&p.to>c&&c!==p.to){l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;break}}while(u);if(c!==r.formatVersion){a.formatVersion.changed=!0,a.formatVersion.new=c;const h=this.defaultSettings.version;h&&(l.version=h)}if(a.formatVersion.changed){for(const f of Object.keys(r))delete r[f];Object.assign(r,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return a.newSettings=r,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}(Xt,Kt);function Zt(){return Zt=Yt(jt().mark((function e(){var t,n,o,r,i,a,s,l,c,u,d,p,h,m,g,v,_,y,E,w,x,T,P,A,C,D,N;return jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return N=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=document.createElement("details"),r=document.createElement("summary");if(r.textContent="Roadway",o.appendChild(r),null!=t&&t.length){var i=document.createElement("div");i.classList.add("".concat(n,"roadway_options")),t.forEach((function(e,t){var o=document.createElement("div");o.classList.add("".concat(n,"roadway_option"));var r=document.createElement("div");r.classList.add("".concat(n,"option_actions"));var a=document.createElement("div");a.classList.add("".concat(n,"action_button"),"".concat(n,"impersonate_action")),a.innerHTML="✍️",a.title="Impersonate";var s=document.createElement("div");s.classList.add("".concat(n,"action_button"),"".concat(n,"edit_action")),s.innerHTML="✏️",s.title="Edit";var l=Qt.getSettings(),c=document.createElement("div");c.classList.add("".concat(n,"action_button"),"".concat(n,"use_action")),c.innerHTML="▶️",c.title="Use option",c.style.display=l.showUseActionIcon?"inline-block":"none",r.appendChild(c),r.appendChild(a),r.appendChild(s);var u=document.createElement("div");u.classList.add("".concat(n,"option_content")),u.textContent=e,o.appendChild(r),o.appendChild(u),i.appendChild(o)})),o.appendChild(i)}else{var a=document.createElement("pre");a.classList.add("".concat(n,"roadway_pre")),a.textContent=e,o.appendChild(a)}return o.outerHTML},p=function(){var e,t=i.promptPresets[i.promptPreset];c.val(null==t?void 0:t.extractionStrategy);var n="none"===(null==t?void 0:t.extractionStrategy);u.toggle(!n),d.val(null!==(e=null==t?void 0:t.impersonate)&&void 0!==e?e:"")},e.next=4,Vt.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 4:o=e.sent,$("#extensions_settings").append(o),r=$(".roadway_settings"),i=Qt.getSettings(),Vt.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",i.profileId,(function(e){var t;i.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Qt.saveSettings()})),a=O(".roadway_settings select.prompt",{label:function(e){return e},initialValue:i.promptPreset,initialList:Object.keys(i.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=Yt(jt().mark((function e(t,n){var o,r,a,s,p,h,f;return jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f=null!=n?n:"default",i.promptPreset=f,Qt.saveSettings(),l.val(null!==(o=null===(r=i.promptPresets[f])||void 0===r?void 0:r.content)&&void 0!==o?o:""),c.val(null===(a=i.promptPresets[f])||void 0===a?void 0:a.extractionStrategy),d.val(null!==(s=null===(p=i.promptPresets[f])||void 0===p?void 0:p.impersonate)&&void 0!==s?s:""),u.css("display","none"===(null===(h=i.promptPresets[f])||void 0===h?void 0:h.extractionStrategy)?"none":"block");case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n,o,r=i.promptPresets[i.promptPreset];i.promptPresets[e]={content:null!==(t=null==r?void 0:r.content)&&void 0!==t?t:zt,extractionStrategy:null!==(n=null==r?void 0:r.extractionStrategy)&&void 0!==n?n:"bullet",impersonate:null!==(o=null==r?void 0:r.impersonate)&&void 0!==o?o:qt}}},rename:{onAfterRename:function(e,t){i.promptPresets[t]=i.promptPresets[e],delete i.promptPresets[e]}},delete:{onAfterDelete:function(e){delete i.promptPresets[e]}}}),s=a.select,(l=r.find("textarea.prompt")).val(null!==(t=null===(n=i.promptPresets[i.promptPreset])||void 0===n?void 0:n.content)&&void 0!==t?t:""),l.on("change",(function(){var e=l.val();i.promptPresets[i.promptPreset].content=e,Qt.saveSettings()})),c=r.find("select.extraction_strategy"),u=r.find(".impersonate_section"),d=r.find("textarea.impersonate"),p(),c.on("change",(function(){var e=$(this).val();i.promptPresets[i.promptPreset].extractionStrategy=e,Qt.saveSettings();var t="none"===e;u.toggle(!t)})),d.on("change",(function(){i.promptPresets[i.promptPreset].impersonate=$(this).val(),Qt.saveSettings()})),s.addEventListener("change",p),r.find(".restore_default").on("click",Yt(jt().mark((function e(){return jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Vt.Popup.show.confirm("Are you sure you want to restore the default prompt?","Restore default");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:i.promptPresets.default={content:zt,extractionStrategy:"bullet",impersonate:qt},l.val(zt),c.val("bullet"),d.val(qt),"default"!==s.value?(s.value="default",s.dispatchEvent(new Event("change"))):Qt.saveSettings();case 10:case"end":return e.stop()}}),e)})))),h=r.find(".max_context_type"),m=r.find(".max_context_value"),g=r.find(".max_context_custom"),h.val(i.maxContextType),m.val(i.maxContextValue),"custom"===i.maxContextType&&g.show(),h.on("change",(function(){var e=$(this).val();i.maxContextType=e,Qt.saveSettings(),g.toggle("custom"===e)})),m.on("change",(function(){i.maxContextValue=Number($(this).val()),Qt.saveSettings()})),(v=r.find(".max_response_tokens")).val(i.maxResponseToken),v.on("change",(function(){i.maxResponseToken=Number($(this).val()),Qt.saveSettings()})),(_=r.find(".auto_trigger")).prop("checked",i.autoTrigger),_.on("change",(function(){i.autoTrigger=$(this).prop("checked"),Qt.saveSettings()})),(y=r.find(".auto_open")).prop("checked",i.autoOpen),y.on("change",(function(){i.autoOpen=$(this).prop("checked"),Qt.saveSettings()})),(E=r.find(".show_use_action")).prop("checked",i.showUseActionIcon),E.on("change",(function(){i.showUseActionIcon=$(this).prop("checked"),Qt.saveSettings(),$(".custom-roadway_options .custom-use_action").toggle(i.showUseActionIcon)})),(w=r.find(".auto_submit_use_action")).prop("checked",i.autoSubmitUseAction),w.on("change",(function(){i.autoSubmitUseAction=$(this).prop("checked"),Qt.saveSettings()})),(x=r.find(".use_no_ass")).prop("checked",i.useNoAss),x.on("change",(function(){i.useNoAss=$(this).prop("checked"),Qt.saveSettings()})),(T=r.find(".formatted_roleplay_message_position")).val(i.formattedRoleplayMessagePosition),T.on("change",(function(){i.formattedRoleplayMessagePosition=$(this).val(),Qt.saveSettings()})),(P=r.find(".no_ass_role")).val(i.noAssRole),P.on("change",(function(){i.noAssRole=$(this).val(),Qt.saveSettings()})),(A=r.find("select.impersonate_api")).val(i.impersonateApi),A.on("change",(function(){i.impersonateApi=$(this).val(),Qt.saveSettings()})),C=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(C),D=new Set,$(document).on("click",".mes_magic_roadway_button",Yt(jt().mark((function e(){var t,n,o,r,a,s,l,c,u,d,p,h,m,g,v,_,y,E,w;return jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),i.profileId){e.next=5;break}return e.next=4,S("error","Please select a connection profile first in the settings.");case 4:case 8:case 22:return e.abrupt("return");case 5:if(i.promptPreset){e.next=9;break}return e.next=8,S("error","Please enter a prompt first in the settings.");case 9:if(o=$(this).closest(".mes"),r=Number(o.attr("mesid")),a=null===(t=n.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find((function(e){return e.id===i.profileId})),s=null!=a&&a.api?n.CONNECT_API_MAP[a.api]:null,l=n.chat.find((function(e,t){return t===r})),l){e.next=16;break}return e.abrupt("return");case 16:if(c=-1!==(c=f.characters.findIndex((function(e){return e.avatar===l.original_avatar})))?c:void 0,e.prev=18,!D.has(r)){e.next=23;break}return e.next=22,S("warning","A request for this message is already in progress. Please wait.");case 23:return D.add(r),$(this).addClass("spinning"),e.next=27,R(null==s?void 0:s.selected,{targetCharacterId:c,messageIndexesBetween:{end:r},presetName:null==a?void 0:a.preset,contextName:null==a?void 0:a.context,instructName:null==a?void 0:a.instruct,syspromptName:null==a?void 0:a.sysprompt,maxContext:"custom"===i.maxContextType?i.maxContextValue:"profile"===i.maxContextType?"preset":"active",includeNames:!!b.selected_group});case 27:return p=e.sent,h=[],i.useNoAss?h.push(en(p.result,i.promptPresets[i.promptPreset].content,i.noAssRole,i.formattedRoleplayMessagePosition)):(h.push.apply(h,$t(p.result)),h.push({content:n.substituteParams(i.promptPresets[i.promptPreset].content),role:"user"})),e.next=32,n.ConnectionManagerRequestService.sendRequest(i.profileId,h,i.maxResponseToken);case 32:if(m=e.sent,g=[],"bullet"!==(v=null===(u=i.promptPresets[i.promptPreset])||void 0===u?void 0:u.extractionStrategy)){e.next=40;break}if(0!==(g=Jt(m.content)).length){e.next=40;break}return e.next=40,S("warning","Could not extract any bullet points from the response. Using original response.");case 40:return _=null!==(d=g)&&void 0!==d&&d.length?g.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"):m.content,y=n.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t[Wt.TARGET])===r})),E=null!=y?y:{mes:N(_,"bullet"===v?g:void 0),name:f.systemUserName,force_avatar:f.system_avatar,is_system:!0,is_user:!1,extra:Gt(Gt(Gt({isSmallSys:!0},Wt.TARGET,r),Wt.RAW_CONTENT,_),Wt.OPTIONS,g)},y?(E.mes=N(_,"bullet"===v?g:void 0),E.extra[Wt.RAW_CONTENT]=m.content,E.extra[Wt.OPTIONS]=g,$('[mesid="'.concat(r+1,'"] .mes_text')).html(N(_,"bullet"===v?g:void 0,"custom-"))):(n.chat.push(E),n.addOneMessage(E,{insertAfter:r})),w=$('[mesid="'.concat(r+1,'"] .mes_text details')),i.autoOpen&&!w.attr("open")&&w.attr("open",""),on(r+1),e.next=49,n.saveChat();case 49:e.next=56;break;case 51:return e.prev=51,e.t0=e.catch(18),console.error(e.t0),e.next=56,S("error","Error: ".concat(e.t0));case 56:return e.prev=56,D.delete(r),$(".mes_magic_roadway_button").removeClass("spinning"),e.finish(56);case 60:case"end":return e.stop()}}),e,this,[[18,51,56,60]])}))));case 60:case"end":return e.stop()}}),e)}))),Zt.apply(this,arguments)}function Jt(e){return(e.match(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)(.*)$/gm)||[]).map((function(e){return e.replace(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)/,"").trim()}))}function en(e,t,n,o){var r=SillyTavern.getContext(),i=e.filter((function(e){return"system"!==e.role})).map((function(e){return"user"===e.role?"{{user}}: ".concat(e.content):"assistant"===e.role?"{{char}}: ".concat(e.content):void 0})).join("\n\n");return"append_bottom"===o?{content:r.substituteParams(t+"\n"+i),role:n}:"append_top"===o?{content:r.substituteParams(i+"\n"+t),role:n}:{content:r.substituteParams(t.replace("{{roadwayNoAssMessages}}",i)),role:n}}var tn,nn=new class{requestMap;constructor(){this.requestMap=new Map}abortRequest(e){const t=this.requestMap.get(e);if(t){if(t.abortController)try{t.abortController.abort()}catch(e){}t.options?.onFinish&&t.options.onFinish(),this.requestMap.delete(e)}}async generateRequest(e,t){const n=SillyTavern.getContext(),o=n.uuidv4(),r=e?.custom?.stream??!1;if(this.requestMap.set(o,{abortController:t?.abortController,isStream:r,options:t}),r)try{const r=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);let i;t?.onStart&&t.onStart(o);for await(const e of r())i=e,t?.onEntry&&t.onEntry(e);t?.onFinish&&t.onFinish(i)}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(o)}else try{t?.onStart&&t.onStart(o);const r=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);this.requestMap.get(o)&&(t?.onEntry&&t.onEntry(r),t?.onFinish&&t.onFinish(r))}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(o)}return o}getActiveRequest(e){return this.requestMap.get(e)?.abortController}getAllActiveRequests(){const e=new Map;for(const[t,n]of this.requestMap)e.set(t,n.abortController);return e}};function on(e){var t=$('[mesid="'.concat(e,'"] .custom-roadway_options'));t.find(".custom-action_button").off();var n=SillyTavern.getContext();t.find(".custom-impersonate_action").on("click",Yt(jt().mark((function o(){var r,i,a,s,l,c,u,d,p,h,f,m,g,v,_,y,E,x,T,P,A;return jt().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(i=$(this).closest(".custom-roadway_option"),a=t.find(".custom-roadway_option").index(i),s=n.chat.find((function(t,n){return e===n})),s){o.next=5;break}return o.abrupt("return");case 5:if(l=Qt.getSettings(),(c=l.promptPresets[n.extensionSettings[Xt].promptPreset])&&c.impersonate){o.next=11;break}return o.next=10,S("error","Preset not found. Please check the extension settings.");case 10:return o.abrupt("return");case 11:if(u=Vt.substituteParams(c.impersonate,void 0,void 0,void 0,void 0,void 0,{roadwaySelected:null===(r=s.extra)||void 0===r||null===(r=r[Wt.OPTIONS])||void 0===r?void 0:r[a]},void 0),"profile"!==l.impersonateApi){o.next=49;break}if(l.profileId){o.next=17;break}return o.next=16,S("error","Please select a connection profile first in the settings.");case 16:return o.abrupt("return");case 17:if(p=null===(d=n.extensionSettings.connectionManager)||void 0===d||null===(d=d.profiles)||void 0===d?void 0:d.find((function(e){return e.id===l.profileId})),null!=(h=null!=p&&p.api?n.CONNECT_API_MAP[p.api]:null)&&h.selected){o.next=22;break}return S("error","Please select an API in the connection profile."),o.abrupt("return");case 22:return Vt.deactivateSendButtons(),o.prev=23,o.next=26,R(h.selected,{presetName:null==p?void 0:p.preset,contextName:null==p?void 0:p.context,instructName:null==p?void 0:p.instruct,syspromptName:null==p?void 0:p.sysprompt,maxContext:"custom"===l.maxContextType?l.maxContextValue:"profile"===l.maxContextType?"preset":"active",includeNames:!!b.selected_group});case 26:return f=o.sent,m=[],l.useNoAss?m.push(en(f.result,u,"system",l.formattedRoleplayMessagePosition)):(m.push.apply(m,$t(f.result)),m.push({role:"system",content:u})),g=!0,v=l.maxResponseToken,"openai"===h.selected?(_=Vt.getPresetManager("openai").getCompletionPresetByName(null==p?void 0:p.preset))&&(g=_.stream_openai,v=_.openai_max_tokens):"textgenerationwebui"===h.selected&&(y=Vt.getPresetManager("textgenerationwebui").getCompletionPresetByName(null==p?void 0:p.preset))&&(g=null!==(E=null!==(x=y.streaming)&&void 0!==x?x:n.textCompletionSettings.streaming)&&void 0!==E&&E,v=null!==(T=y.genamt)&&void 0!==T?T:v),P=$("#send_textarea"),A=new AbortController,o.next=36,nn.generateRequest({profileId:l.profileId,prompt:m,maxTokens:v,custom:{stream:g,signal:g?A.signal:void 0}},{abortController:g?A:void 0,onStart:function(e){tn=e,Vt.eventSource.emit(Ft.GENERATION_STARTED,"impersonate",{signal:g?A.signal:void 0})},onEntry:function(e){g&&e&&(P.val(e.text),P.trigger("input"),P.trigger("change"))},onFinish:function(e,t){!g&&e&&(P.val(e.content),P.trigger("input"),P.trigger("change")),t&&S("error","Error: ".concat(t)),Vt.activateSendButtons()}});case 36:o.next=43;break;case 38:return o.prev=38,o.t0=o.catch(23),console.error(o.t0),o.next=43,S("error","Error: ".concat(o.t0));case 43:return o.prev=43,Vt.activateSendButtons(),tn=void 0,o.finish(43);case 47:o.next=50;break;case 49:w("impersonate",void 0,u);case 50:case"end":return o.stop()}}),o,this,[[23,38,43,47]])})))),t.find(".custom-use_action").on("click",(function(){var e=$(this).closest(".custom-roadway_option").find(".custom-option_content").text();if(e){$("#send_textarea").val(e),$("#send_textarea").trigger("input"),Qt.getSettings().autoSubmitUseAction&&$("#send_but").trigger("click");var t=$(this);t.html("✓"),setTimeout((function(){t.html("▶️")}),1e3)}})),t.find(".custom-edit_action").on("click",Yt(jt().mark((function o(){var r,i,a,s;return jt().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:r=$(this).closest(".custom-roadway_option"),i=r.find(".custom-option_content"),a=i.text(),s=$("<textarea>").val(a).css({width:"100%",minHeight:"50px",resize:"vertical",backgroundColor:"var(--SmartThemeBlurTintColor)",color:"var(--SmartThemeBodyColor)",border:"1px solid var(--SmartThemeBorderColor)",borderRadius:"var(--avatar-base-border-radius)",padding:"calc(var(--mainFontSize) * 0.5)"}),i.empty().append(s),s.trigger("focus"),s.on("blur",(function(){var o,a=s.val();i.text(a);var l=n.chat.find((function(t,n){return e===n}));if(null!=l&&null!==(o=l.extra)&&void 0!==o&&o[Wt.OPTIONS]){var c=t.find(".custom-roadway_option").index(r);l.extra[Wt.OPTIONS][c]=a,n.saveChat()}})),s.on("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s.trigger("blur"))}));case 8:case"end":return o.stop()}}),o,this)}))))}function rn(){!function(){Zt.apply(this,arguments)}(),function(){Vt.eventSource.on(Ft.CHAT_CHANGED,(function(){var e,t=SillyTavern.getContext();t.chat.length&&($(".custom-roadway_options .custom-use_action").toggle(Qt.getSettings().showUseActionIcon),"number"==typeof(null===(e=t.chat[t.chat.length-1].extra)||void 0===e?void 0:e[Wt.TARGET])&&on(t.chat.length-1))}));var e=-1;Vt.eventSource.makeFirst(Ft.CHARACTER_MESSAGE_RENDERED,(function(t,n){e=t,Qt.getSettings().autoTrigger&&"group_chat"!==n&&!b.selected_group&&$('[mesid="'.concat(t,'"]')).find(".mes_magic_roadway_button").trigger("click")}));var t=["normal","continue","swipe"];Vt.eventSource.makeFirst(Ft.GROUP_WRAPPER_FINISHED,(function(n){Qt.getSettings().autoTrigger&&-1!==e&&t.includes(n.type)&&$('[mesid="'.concat(e,'"]')).find(".mes_magic_roadway_button").trigger("click")})),$("#mes_stop").on("click",(function(){tn&&nn.abortRequest(tn)}))}()}if(Vt.ConnectionManagerRequestService&&Vt.getCharacterCardFields&&Vt.getWorldInfoPrompt)Qt.initializeSettings().then((function(e){e.version.changed&&e.oldSettings.version<"0.4.0"&&"0.4.0"===e.newSettings.version&&S("info","[Roadway] Added impersonate with connection profile api. Check extension settings."),rn()})).catch((function(e){S("error",e),Vt.Popup.show.confirm("Data migration failed. Do you want to reset the roadway data?","Roadway").then((function(e){e&&(Qt.resetSettings(),rn())}))}));else{S("error","[Roadway Error] Make sure ST is updated.")}var an=p.b;export{an as noAss};